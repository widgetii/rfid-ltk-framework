Накопитель RFID
===============

Это приложение получает данные от настроенных провайдеров и пересылает его
клиентам.


Алгоритм взаимодействия
-----------------------

- Клиент, зная адрес накопителя, инициирует соединение с ним.
- В запросе клиент указывает адрес (на узле клиента), по которому удалённый
  накопитель должен высылать сообщения, а также свой уникальный идентификатор
  в виде UUID.
- Если клиент с указанным идентификатором уже зарегистрирован, то накопитель
  отвечает отказом. В этом случае клиент может изменить идентификатор и
  повторить запрос.
- В случае успеха, накопитель регистрирует клиента и начинает присылать ему
  сообщения о событиях (тег появился/тег исчез, изменения состояния) на
  указанный адрес и с указанным идентификатором.
- Если идентификатор, присланный накопителем в запросе, не совпадает с
  идентификатором клиента, клиент должен ответить сообщением об ошибке.
- В случае успешной обработки запроса, клиент должен ответить статусом HTTP 20x.
- По окончании работы клиент уведомляет накопитель.


Поддержание соединения
----------------------

- Накопитель, через определённые промежутки времени, высылает клиенту запросы
  (пинги), если других данных нет.
- Если клиент не получает запросов от накопителя в течение некоторого промежутка
  времени, то соединение считается разорванным.
- После разрыва соединения, клиент должен установить соединение с накопителем
  заново, повторяя попытки пока это не удастся.
- Если накопитель не может отправить данные клиенту, ввиду разрыва соединения
  или потому, что тот ответил статусом ошибки HTTP, то накопитель прекращает
  работу с клиентом.

Таким образом, ответственность за поддержание соединения лежит на клиенте.


Установка
---------

Собранное командой `ant` приложение оказывается в поддиректории `target`.


Запуск
------

Запуск приложения осуществляется стандартным для Equinox способом. Для этого из
директории, в которой установлено приложение, необходимо вызвать команду

``` bash
java -jar plugins/org.eclipse.equinox.launcher_${version}.jar
```

где `${version}` - это версия пакета.

В директории `install/debian/init.d` лежит скрипт инициализации демона
накопителя с названием `rfcollector`, который можно использовать в
Debian GNU/Linux для запуска и остановки накопителя штатными средствами.


Работа
------

Чтобы проверить, работает ли накопитель, можно зайти на страницу его веб-сервера
по адресу вида `http://<host>:<port>/collector/`. На этой странице будут
отображены все доступные профили оборудования, а также их адреса, по которым
клиенты (в частности, приёмники хранилища) должны обращаться.


Настройка
---------

Файлы приложения копируется из выбранного профиля сборки, указанного в качестве
параметра команды `ant` в виде: `ant -Dprofile=<profile>`, гдк `<profile>` - это
имя профиля.

Профиль сборки - имя поддиректория, которая ищется вначале в директории `local`,
а если не найдена там - то в директории `profiles`. Если имя профиля сборки не
указано, то используется профиль `default`. Файлы из профиля `default` также
копируются, если отсутствуют в выбранном профиле.

Профили, находящиеся в директории `local` исключены из системы контроля версий,
в отличие от профилей, находящихся в директории `profiles`.

Основные настройки приложения хранятся в файле `configuration/config.ini`.

Помимо [стандартных опций Equinox][equinox_config], а также настроек
HTTP-сервера, в этом файле могут (должны!) содержаться настройки накопителя.

Настройка накопителя состоит в настройке его профилей. Каждый профиль - это
настройка RFID (`RfSettings`) для определённого провайдера (`RfProvider`).
Именно в профиле содержится информация о том, как соединяться с ридером, а также
прочие настройки режима функционирования.


[equinox_config]: http://help.eclipse.org/indigo/index.jsp?topic=%2Forg.eclipse.platform.doc.isv%2Freference%2Fmisc%2Fruntime-options.html


### Профили накопителя ###

Названия свойств настроек профилей начинаются с префикса `ru.aplix.ltk.rf.`.
Далее следует идентификатор провайдера (`RfProvider.getId()`). Например, `ctg` -
идентификатор драйвера непрерывного чтения.

Далее, через точку, следует имя свойства.

Пример:

```
ru.aplix.ltk.rf.ctg.connectionTimeout=45000
ru.aplix.ltk.rf.ctg.roSpecId=101

```

У профиля есть флаг автоматического запуска (`autostart`), который сброшен по
умолчанию. Если этот флаг установлен, то накопитель профиля начинает работу
немедленно и завершает её лишь вместе с приложением. В противном случае
накопитель начинает работу при подключении первого клиента и завершает её при
отключении последнего.

Начинать работу немедленно имеет смысл лишь логирующему накопителя (например,
`ctg-log`), который хранит события появления и исчезновения тегов и может
отправить их клиенту позже, по запросу. Рекомендуется установить флаг
автоматического запуска (`autostart=true`) для одного из профилей такого
накопителя.


### Несколько профилей одного провайдера ###

Для каждого провайдера может быть создано несколько профилей. Например, если
один накопитель работает с несколькими ридерами.

В этом случае, сначала нужно указать названия профилей провайдера:

```
ru.aplix.ltk.rf.ctg=store,delivery,gates
```

А затем - настроить каждый профиль. Названия свойств в этом случае будут
начинаться с префикса вида `ru.aplix.ltk.rf.<provider>.<profile>.`.

Пример:

```
ru.aplix.ltk.rf.ctg.store.readerHost=10.99.203.234
ru.aplix.ltk.rf.ctg.delivery.readerHost=10.99.203.236
ru.aplix.ltk.rf.ctg.gates.readerHost=10.99.203.235
ru.aplix.ltk.rf.ctg.gates.roSpecId=102
```

> **ВНИМАНИЕ!** Если для провайдера заданы профили, то возможна настройка только
> этих профилей. Настройки с префиксами, отличными от префиксов профилей, будут
> проигнорированы.

> **ЗАМЕЧАНИЕ.** Если оставить список профилей провайдера пустым, то провайдер будет
> недоступен.


### Свойства настроек ###

Документация по конкретным именам свойств и их значениям - в директории `doc`.
Например, настройки для драйвера непрерывного чтения лежат в файле `doc/ctg.md`.
