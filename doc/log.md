Лог тегов
=========

Лог тегов - это реализация накопителя RFID, которая получает сообщения о
появлении и исчезновении тегов RFID от другой реализации накопителя, записывает
сообщения в постоянное хранилище (лог) и отправляет теги получателям.
Каждому сохранённому сообщению присваивается уникальны возрастающий числовой
идентификатор. Сохранённые сообщения могут быть отправлены получателю повторно
по запросу, начиная с указанного идентификатора (исключительно).


Включение
---------

Чтобы включить лог тегов, необходимо добавить пакет `ru.aplix.ltk.collector.log`
в приложение и включить его на старте (например, через файл `config.ini`).

При этом для каждого найденного поставщика RFID (службы OSGi реализующей
интерфейс `RfProvider`) будет создан новый поставщик с теми же настройками и
функциональностью, что и оригинальный, но дополнительно записывающий сообщения
в лог.

Идентификатор такого поставщика будет равен идентификатору оригинального
поставщика с добавленным окончанием `-log` (идентификатор поставщика важно знать
для его настройки). Например, драйвер непрерывного чтения имеет идентификатор
`ctg`. Созданный для него логгирующий поставщик RFID получит идентификатор
`ctg-log`. Пользоваться можно и тем, и другим одинаково.


Настройка
---------

Настройки логгирования можно поместить в файл `config.ini`. Имена настроек
начинаются с `ru.aplix.ltk.collector.log.`.

Поддерживаются следующие настройки (в скобках - значение по умолчанию):

- `dir` - директория, в которой будут созданы файлы логов. По умолчанию файлы
  будут созданы в хранилище, предоставленном OSGi. Однако это нежелательно,
  поскольку такие файлы будут стёрты при запуске приложения с опцией `-clean`
  или если в файле настроек приложения содержится `osgi.clean=true`, что то же
  самое. Так что лучше указывать директорию явно.
- `filter` - LDAP-фильтр выбора служб-поставщиков RFID (`RfProvider`), для
  которых будет создаваться лог. По умолчанию лог создаётся для всех
  поставщиков.
- `fsync` (false) - выполнять ли принудительную синхронизацию данных на диск
  после каждой записи (см. `StandardOpenOption.DSYNC`).
- `fsyncMeta` (false) выполнять ли принудительную синхронизацию мета-данных
  на диск после каждой записи (см. `StandardOpenOption.SYNC`). Используется
  только если опция `fsync` включена.
- `logAppearance` (true) - сохранять ли в лог события появления тегов.
- `logDisappearance` (true) - сохранять ли в лог события исчезновения тегов.
- `size` (33554432, т.е. 1 GiB) - наибольшее количество записей в логе. Одна
  запись - 32 байта (см. описание формата данных).


Формат данных
-------------

Лог сообщений для каждого поставщика хранится в трёх файлах с названиями:

- `<id>.tags` - сам лог, хранит сообщения.
- `<id>.tags.id` - хранит идентификатор последнего сохранённого сообщения.
- `<id>.tags.pos` - хранит позицию записи в лог.

Здесь `<id>` - это идентификатор поставщика RFID, для которого создан лог
(например, `ctg`).

Файлы `.tags.id` и `.tags.pos` хранят 64-битные числа в двоичном виде. Их размер
всегда 8 байт (или 0 байт, если данные ещё не записывались).

Каждая запись в логе имеет размер строго 32 байта:

- 8 байт на идентификатор сообщения;
- 8 байт на время события (время UNIX в миллисекундах);
- 1 байт на флаги (1 - появление тега, 0 - исчезновение);
- 1 байт на длину тега;
- не более 12 байт тега;
- 1 байт на контрольную сумму (CRC8).

Возрастающие идентификаторы тегов позволяют осуществлять двоичный поиск по логу.

Запись данных с лог осуществляется последовательно. Как только лог достигает
максимального размера, запись начинается с начала лога. Размер лога при этом
больше не меняется.

Если изменить наибольший размер лога (настройка `size`), то лог изменит свой
размер, как только это станет возможным без потери записанных данных. Например,
удалив лишь самые старые записи (записи с наименьшим идентификатором). Если в
логе присутствует запись `N`, и запись `N+1` была когда-то выполнена, то запись
`N+1` также присутствует в логе, даже если его размер менялся. Короче, "дырок" в
логе не образуется.
